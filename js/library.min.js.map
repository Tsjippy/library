{"version":3,"file":"library.min.js","mappings":"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","sources":["webpack://library/../../forms/js/form_exports.js","webpack://library/./library.js"],"sourcesContent":["import { getFieldValue } from  '../../../plugins/sim-baseludes/js/partials/field_value.js';\n\nexport function removeDefaultSelect(el){\n\tArray.from(el.options).forEach(function(option){\n\t\toption.defaultSelected = false;\n\t});\n}\n\nlet tinymceSettings = [];\nfunction prepareForCloning(originalNode){\n\t//also remove any tinymce's\n\tif(typeof(tinymce) != 'undefined'){\n\t\toriginalNode.querySelectorAll('.wp-editor-area').forEach(el =>{\n\t\t\tlet tn = tinymce.get(el.id);\n\t\t\tif(tn != null){\n\t\t\t\ttinymceSettings[el.id] = tn.settings\n\t\t\t\ttn.save();\n\t\t\t\ttn.remove();\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport function cloneNode(originalNode, clear=true){\n\tprepareForCloning(originalNode);\n\t\n\t//make a clone\n\tlet newNode = originalNode.cloneNode(true);\n\n\t// remove niceselect drop down from clone\n\tnewNode.querySelectorAll('.nice-select').forEach(dropdown => dropdown.remove());\n\t\n\t//add tinymce's again\n\toriginalNode.querySelectorAll('.wp-editor-area').forEach(el =>{\n\t\tif(tinymceSettings[el.id] != undefined){\n\t\t\ttinymce.init(tinymceSettings[el.id]);\n\t\t}\n\t});\n\t\n\t//clear values in the clone\n\tif(clear){\n\t\tnewNode.querySelectorAll('input,select,textarea').forEach(input => {\n\t\t\tif(input.type == 'checkbox' || input.type == 'radio'){\n\t\t\t\tinput.checked = false;\n\t\t\t}else if(!input.matches('.no-reset') ){\n\t\t\t\tinput.value = \"\";\n\t\t\t}\n\t\t\t\n\t\t\t//if this is a select\n\t\t\tif(input.type == \"select-one\"){\n\t\t\t\t//remove any defaults\n\t\t\t\tremoveDefaultSelect(input);\n\t\t\t}\n\t\t});\n\t}\n\n\tnewNode.querySelectorAll('select').forEach(select => {\n\t\t//remove any defaults\n\t\tremoveDefaultSelect(select);\n\n\t\tMain.attachNiceSelect(select);\n\t});\n\t\n\treturn newNode;\n}\n\nexport function copyFormInput(originalNode){\n\toriginalNode.querySelectorAll('.remove.hidden').forEach( el => el.classList.remove('hidden'));\n\n\tlet newNode = cloneNode(originalNode);\n\t\n\t//update the data index\n\tnewNode.querySelectorAll('.upload-files').forEach(function(uploadButton){\n\t\tuploadButton.dataset.index = nodeNr;\n\t})\n\t\n\t//Clear contents of any document preview divs.\n\tnewNode.querySelectorAll('.document-preview').forEach(function(previewDiv){\n\t\tpreviewDiv.innerHTML = '';\n\t});\n\n\t//Select\n\tlet i = 0;\n\tnewNode.querySelectorAll('select').forEach(select => {\n\t\t//Find the value of the select we have cloned\n\t\tlet previousVal = originalNode.getElementsByTagName('select')[i].selectedIndex;\n\t\t\n\t\t//Hide the value in the clone\n\t\tif(select.options[previousVal] != undefined){\n\t\t\tselect.options[previousVal].style.display = 'none';\n\t\t}\n\t\t\n\t\t//Add nice select\n\t\tMain.attachNiceSelect(select);\n\t\t\n\t\ti++;\n\t});\n\n\t// process tab buttons\n\tif(originalNode.matches('.tabcontent')){\n\t\t// Hide original\n\t\toriginalNode.classList.add('hidden');\n\n\t\t// Add button for the new one\n\t\tlet orgButton\t= originalNode.closest('.clone-divs-wrapper').querySelector(`.tablink.active`);\n\t\tlet newButton\t= cloneNode(orgButton);\n\n\t\t// make the org butto inactive\n\t\torgButton.classList.remove('active');\n\n\t\t//Insert the clone\n\t\torgButton.parentNode.insertBefore(newButton, orgButton.nextSibling);\n\t}\n\t\n\t//Insert the clone\n\toriginalNode.parentNode.insertBefore(newNode, originalNode.nextSibling);\n\n\t// Process formsteps\n\tif(originalNode.matches('.formstep')){\n\t\t// hide the new clone\n\t\tnewNode.classList.add('step-hidden');\n\n\t\t// Update the formstep controls\n\t\tlet form\t\t= originalNode.closest('form');\n\t\tif(form != null && form.querySelector('.multi-step-controls-wrapper') != null){\n\t\t\tupdateMultiStepControls(form);\n\t\t}\n\n\t\tlet text\t= originalNode.querySelector('.add.button').textContent.replace('Add ', '');\n\n\t\tMain.displayMessage(`Succesfully added an extra ${text}<br>Its added as the next page.`);\n\t}\n\t\n\treturn newNode;\n}\n\nexport function fixNumbering(wrapper){\n\twrapper.querySelectorAll(':scope > .clone-div, :scope > .tablink').forEach(updateNumbers);\n\n\tfunction updateNumbers(clone, index){\n\t\t//Update the new number\t\n\n\t\t// Update the ID\n\t\tif(clone.id != ''){\n\t\t\tclone.id = clone.id.replace(/[0-9]+(?!.*[0-9])/, index);\n\t\t}\n\t\t\n\t\t// Update the content\n\t\tif(clone.type == 'button' && clone.textContent != ''){\n\t\t\tclone.textContent \t\t= clone.textContent.replace(/[0-9]+(?!.*[0-9])/, index + 1);\n\n\t\t\tclone.dataset.target\t= clone.dataset.target.replace(/[0-9]+(?!.*[0-9])/, index);\n\t\t}\n\n\t\t// Update the divid attribute\n\t\tif(clone.dataset.divId  != null){\n\t\t\tclone.dataset.divId = index;\n\t\t}\n\t\t\n\t\t//Update the title\n\t\tclone.querySelectorAll('h3, h4, legend :first-child').forEach(el => {\n\t\t\tel.textContent = el.textContent.replace(/[0-9]+(?!.*[0-9])/, index + 1);\n\t\t});\n\t\t\n\t\t//Update the legend\n\t\t/* clone.querySelectorAll('legend').forEach(legend => {\n\t\t\tlegend.textContent = legend.textContent.replace(/[0-9]+(?!.*[0-9])/, ' '+(index+1));\n\t\t}); */\n\t\t\n\t\t//Update the elements\n\t\tclone.querySelectorAll('input,select,textarea').forEach(input => {\n\t\t\t//Do not copy nice selects\n\t\t\tif(!input.classList.contains('nice-select-search')){\n\t\t\t\t//Update the id\n\t\t\t\tif(input.id != '' && input.id != undefined){\n\t\t\t\t\tinput.id = input.id.replace(/[0-9]+(?!.*[0-9])/, index);\n\t\t\t\t}\n\n\t\t\t\t//Update the name\n\t\t\t\tif(input.name != '' && input.name != undefined){\n\t\t\t\t\tinput.name = input.name.replace(/[0-9]+(?!.*[0-9])/, index);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t//Reset the select to the default\n\t\t\t\tif(input.type == 'button'){\n\t\t\t\t\tinput.value = input.value.replace(/[0-9]+(?!.*[0-9])/, index);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport function removeNode(target){\n\tlet node\t\t\t= target.closest(\".clone-div\");\n\tlet parentNode\t\t= node.closest('.clone-divs-wrapper');\n\tlet allCloneDivs\t= parentNode.querySelectorAll('.clone-div');\n\t\n\t//Check if we are removing the last element\n\tif(allCloneDivs[allCloneDivs.length-1] == node){\n\t\tlet addElement = node.querySelector(\".add\");\n\t\t\n\t\t//Move the add button one up\n\t\tlet prev = node.previousElementSibling;\n\t\tif(prev.querySelector('.button-wrapper .add') == null){\n\t\t\tprev.querySelector('.button-wrapper').appendChild(addElement);\n\t\t}\n\t}\n\n\t// check if we need to remove a corresponding tab button\n\tif(node.matches('.tabcontent')){\n\t\tlet buttonToRemove\t= parentNode.querySelector(`.tablink[data-target=\"${node.id}\"]`);\n\t\tif(buttonToRemove != null){\n\n\t\t\t//if the button is active, make the previous one active\n\t\t\tif(buttonToRemove.classList.contains('active')){\n\t\t\t\tlet prevButton\t= buttonToRemove.previousElementSibling;\n\t\t\t\tif(prevButton != null){\n\t\t\t\t\tprevButton.classList.add('active');\n\t\t\t\t\t\n\t\t\t\t\t//show the corresponding tab\n\t\t\t\t\tMain.displayTab(prevButton);\n\t\t\t\t}else{\n\t\t\t\t\t//try the next one\n\t\t\t\t\tlet nextButton\t= buttonToRemove.nextElementSibling;\n\t\t\t\t\tif(nextButton != null){\n\t\t\t\t\t\tnextButton.classList.add('active');\n\t\t\t\t\t\t\n\t\t\t\t\t\t//show the corresponding tab\n\t\t\t\t\t\tMain.displayTab(nextButton);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t//remove the button\n\t\t\tbuttonToRemove.remove();\n\t\t}\n\t}\n\n\t// Check if this is a formstep\n\tif(node.matches('.formstep')){\n\t\tlet newFormstep\t= null;\n\n\t\t// if there is a next clonable formstep, show that one\n\t\tlet nextFormstep\t= parentNode.querySelector(`.formstep[data-div-id='${parseInt(node.dataset.divId) + 1}']`);\n\t\tif(nextFormstep != null){\t\t\t\n\t\t\tnewFormstep\t= nextFormstep;\n\t\t}else{\n\t\t\t//try the previous one\n\t\t\tlet prevFormstep\t= parentNode.querySelector(`.formstep[data-div-id='${parseInt(node.dataset.divId) - 1}']`);\n\t\t\tif(prevFormstep != null){\n\t\t\t\tnewFormstep\t= prevFormstep;\n\t\t\t}\n\t\t}\n\n\t\tif(newFormstep != null){\n\t\t\t//check if we need to update the multi step controls\n\t\t\tlet form\t\t= node.closest('form');\n\t\t\tif(form != null && form.querySelector('.multi-step-controls-wrapper') != null){\n\t\t\t\tupdateMultiStepControls(form);\n\n\t\t\t\t// find the next visible formstep index\n\t\t\t\tform.querySelectorAll('.formstep').forEach((formstep, index) =>{\n\t\t\t\t\tif(formstep == newFormstep){\n\t\t\t\t\t\t//show the next visible formstep\n\t\t\t\t\t\tshowFormStep(index, form);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t//Remove the node\n\tnode.remove();\n\n\t//If there is only one div remaining, hide the remove button\n\tif(parentNode.querySelectorAll('.clone-div').length == 1){\n\t\tlet removeElement = parentNode.querySelector('.remove');\n\t\tremoveElement.classList.add('hidden');\n\t}\n\n\tfixNumbering(parentNode)\n}\n\n/* \n\tFUNCTIONS USED BY DYNAMIC FORMS JS\n */\nexport function tidyMultiInputs(){\n\t//remove unnecessary buttons on inputs with multiple values\n\tdocument.querySelectorAll('.clone-divs-wrapper').forEach( function(div){\n\t\tlet cloneDivArr\t= div.querySelectorAll(':scope > .clone-div');\n\t\t\n\t\tif(cloneDivArr.length == 1){\n\t\t\tcloneDivArr[0].querySelectorAll('.remove').forEach(el=>el.remove());\n\t\t}\n\t\t\n\t\tcloneDivArr.forEach(function(cloneDiv, index, array){\n\t\t\t//update dataset\n\t\t\tcloneDiv.dataset.divId = index;\n\t\t\t\n\t\t\t//remove add button for all but the last\n\t\t\tif(index != array.length - 1){\n\t\t\t\t// Select all add buttons but not the any nested buttons\n\t\t\t\tcloneDiv.querySelectorAll('.add:not(:scope .clone-divs-wrapper .add)').forEach(el=>el.remove());\n\t\t\t}\n\t\t})\n\t});\n}\n\nexport function updateMultiStepControls(form){\n\t// get active formsteps amount\n\tlet formsteps\t\t\t= form.querySelectorAll('.formstep');\n\tlet visibleFormsteps\t= form.querySelectorAll('.formstep:not(.hidden)');\n\tlet stepIndicators\t\t= form.querySelectorAll('.multi-step-controls-wrapper .step');\n\n\t// show all step circles\n\tstepIndicators.forEach(el => el.classList.remove('hidden'));\n\n\t// hide some step circles if needed\n\tfor(let x = visibleFormsteps.length; x < formsteps.length; x++){\n\t\tstepIndicators[x].classList.add('hidden');\n\t}\n\n\t// Add some step circles if needed\n\tfor(let x = stepIndicators.length; x < formsteps.length; x++){\n\t\tlet step\t= document.createElement('span');\n\t\tstep.classList.add('step');\n\n\t\tform.querySelectorAll(`.step-wrapper`).forEach(el => el.appendChild(step));\n\t}\n\n\t// check if this is the last visible\n\tlet currentFormstep\t\t= form.querySelector('.formstep:not(.step-hidden)');\n\tif(visibleFormsteps[visibleFormsteps.length - 1] == currentFormstep){\n\t\t// make the submit button visible\n\t\tform.querySelector('.next-button').classList.add('hidden');\n\t\tform.querySelector('.form-submit ').classList.remove('hidden');\n\t}else{\n\t\tform.querySelector('.next-button').classList.remove('hidden');\n\t\tform.querySelector('.form-submit ').classList.add('hidden');\n\t}\n}\n\t\n/** \n * show a next form step\n * @param {number} n - the form step index to show\n * @param {Element} form - the form contaning the form steps\n */\nexport function showFormStep(n, form) {\n\tif(typeof(form) != 'undefined'){\n\t\tif(n == 0){\n\t\t\t// Hide any loaders\n\t\t\tform.querySelectorAll('.loader-wrapper:not(.hidden), .loader-image-trigger' ).forEach( loader => loader.remove());\n\n\t\t\t//show form controls\n\t\t\tform.querySelectorAll('.multi-step-controls.hidden').forEach(el => el.classList.remove('hidden'));\n\t\t}\n\t\t\n\t\t//hide all formsteps\n\t\tform.querySelectorAll('.formstep:not(.step-hidden)').forEach(step=>step.classList.add('step-hidden'));\n\t\t\n\t\t// Show the specified formstep of the form ...\n\t\tlet x = form.getElementsByClassName(\"formstep\");\n\t\t\n\t\tif(x.length == 0){\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t//scroll back to top\n\t\tlet y = x[n].offsetTop - document.querySelector(\"#masthead\").offsetHeight\n\t\twindow.scrollTo({ top: y, behavior: 'auto'});\n\t\t\n\t\t//show\n\t\tx[n].classList.remove('step-hidden');\n\n\t\t// This function removes the \"active\" class of all steps...\n\t\tform.querySelectorAll(\".step.active\").forEach(el=>{el.classList.remove('active');});\n\n\t\t//... and adds the \"active\" class to the current step:\n\t\tx = form.getElementsByClassName(\"step\");\n\t\ttry{\n\t\t\tx[n].classList.add(\"active\");\n\t\t}catch(err) {\n\t\t\tconsole.log(x);\n\t\t\tconsole.log(n);\n\t\t  \tconsole.error(err.message);\n\t\t}\n\n\t\t// ... and fix the Previous/Next buttons:\n\t\tif (n == 0) {\n\t\t\tform.querySelector('[name=\"previous-button\"]').classList.add('hidden');\n\t\t} else {\n\t\t\tform.querySelector('[name=\"previous-button\"]').classList.remove('hidden');\n\t\t}\n\n\t\tif (n == (x.length - 1)) {\n\t\t\tform.querySelector('[name=\"next-button\"]').classList.add('hidden');\n\t\t\tform.querySelector('.form-submit').classList.remove('hidden');\n\t\t} else {\n\t\t\tform.querySelector('[name=\"next-button\"]').classList.remove('hidden');\n\t\t\tform.querySelector('.form-submit').classList.add('hidden');\n\t\t}\n\t}else{\n\t\tconsole.log('no form defined');\n\t}\n}\n\n//next form step clicked\nexport function nextPrev(n, form) {\n\t// This function will figure out which tab to display\n\tlet x \t\t\t\t= form.querySelectorAll(\".formstep\");\n\tlet stepIndicators\t= form.querySelectorAll(\".step\");\n\tlet currentTab\t\t= 0;\n\tlet valid\t\t\t= true;\n\n\t// Find the current active tab\n\tx.forEach((el, index)=>{if(!el.matches('.step-hidden')){currentTab = index}});\n\t\n\t//Check validity of this step if going forward\n\tif( n > 0){\n\t\t// Prepare the elements on this tab\n\t\tFormSubmit.prepareForValidation(x[currentTab]);\n\n\t\t// Report validity of each required field\n\t\tlet elements\t= x[currentTab].querySelectorAll('input[required], textarea[required], select[required]');\n\t\tfor(const element of elements) {\n\t\t\telement.required\t= true;\n\t\t\tvalid\t\t\t\t= element.reportValidity();\n\t\t\tif(!valid){\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif(!valid) return;\n\t\t\n\t\t//mark the last step as finished\n\t\tstepIndicators[currentTab].classList.add(\"finish\");\n\t}else{\n\t\t//mark the last step as unfinished\n\t\tstepIndicators[currentTab].classList.remove(\"finish\");\n\t}\n\t\n\t//loop over all the formsteps to hide stepindicators of them if needed\n\tArray.from(x).forEach((formstep,index) =>{\n\t\tif(formstep.classList.contains('hidden')){\n\t\t\t//hide the corresponding circle\n\t\t\tstepIndicators[index].classList.add('hidden');\n\t\t}\n\t});\n\n\t// Increase or decrease the current tab by 1:\n\tcurrentTab = currentTab + n;\n\t\n\t//check if the next tab is hidden\n\twhile(x[currentTab].classList.contains('hidden')){\n\t\t//go to the next tab\n\t\tcurrentTab = currentTab + n;\n\n\t\tif (currentTab >= x.length) {\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\t// if you have reached the end of the form... :\n\tif (currentTab >= x.length) {\n\t\treturn false;\n\t}\n\t// Otherwise, display the correct tab:\n\tshowFormStep(currentTab, form);\n\n\treturn true;\n}\n\nexport function changeFieldValue(selector, value, functionRef, form, addition='', forceValue=false){\n\tif(value == undefined){\n\t\treturn;\n\t}\n\n\tlet name\t\t= '';\n\tlet target\t\t= '';\n\n\tif(selector instanceof Element){\n\t\ttarget\t\t= selector;\n\t\tname\t\t= target.name;\n\t\tif(target.id == ''){\n\t\t\tselector\t= `[name^=\"${target.name}\" i]`;\n\t\t}else{\n\t\t\tselector\t= `[id^=${target.id}]`;\n\t\t}\n\t\t\n\t}else{\n\t\ttarget \t\t= form.querySelector(selector);\n\n\t\ttry{\n\t\t\tname\t\t= target.name;\n\t\t}catch{\n\t\t\tconsole.log(target);\n\t\t}\n\t}\n\n\tlet oldValue\t= getFieldValue(target, form, false, value);\n\t// nothing to change\n\tif(oldValue == value){\n\t\treturn;\n\t}\n\n\t// Check if we are dealing with a multi input field\n\tif(target == null){\n\t\tlet targets \t= form.querySelectorAll(`.clone-div [name^=\"${name}\" i]`);\n\t\tif(targets.length === 0){\n\t\t\treturn;\n\t\t}else if(targets.length == 1){\n\t\t\ttarget\t= targets[0];\n\t\t\ttargets\t= '';\n\t\t}else{\n\t\t\ttarget\t= targets[0];\n\n\t\t\ttargets.forEach((el, index) =>{\n\t\t\t\tif(index == 0){\n\t\t\t\t\tchangeFieldValue(el, '', '', form);\n\t\t\t\t}else{\n\t\t\t\t\tremoveNode(el);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t// calculate the new value\n\tif(addition != ''){\n\t\t// check if a date\n\t\tif (/\\d{4}-\\d{2}-\\d{2}/.test(value)){\n\t\t\tlet date\t= new Date(value);\n\t\t\tdate.setDate(date.getDate() + parseInt(addition));\n\t\t\tvalue\t= date.toISOString().split('T')[0];\n\t\t}else{\n\t\t\tvalue\t= value + parseInt(addition);\n\t\t}\n\t}\n\t\n\tif(target.type == 'radio' || target.type == 'checkbox'){\n\t\t// uncheck all\n\t\tif(value == ''){\n\t\t\tif(selector != ''){\n\t\t\t\tform.querySelectorAll(selector).forEach(el=>el.checked=false);\n\t\t\t}\n\t\t}else{\n\t\t\t// Check if the current target is the one we need to check\n\t\t\tif(target.value.toLowerCase() == value.toLowerCase()){\n\t\t\t\ttarget.checked = true;\n\t\t\t}else{\n\t\t\t\t// find the element with the given value and check it\n\t\t\t\tlet targets = form.querySelectorAll(`[name=\"${name}\" i]`);\n\t\t\t\tfor (const element of targets) {\n\t\t\t\t\tif(element.value.toLowerCase() == value.toLowerCase()){\n\t\t\t\t\t\telement.checked = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t//the target has a list attached to it\n\t}else if(target.type == 'date'){\n\t\ttarget.value = value;\n\t\t\n\t\t// convert a date to the right format\n\t\tif (!/\\d{4}-\\d{2}-\\d{2}/.test(value)){\n\t\t\tlet splitted = '';\n\t\t\tif(value.split('-').length == 3){\n\t\t\t\tsplitted\t= value.split('-');\n\t\t\t}else if(value.split('/').length == 3){\n\t\t\t\tsplitted\t= value.split('/');\n\t\t\t}\n\n\t\t\tif(splitted != ''){\n\t\t\t\tlet year;\n\t\t\t\tlet month;\n\t\t\t\tlet day;\n\t\t\t\tsplitted.forEach(nr=>{\n\t\t\t\t\tif(nr.length == 4){\n\t\t\t\t\t\tyear\t= nr;\n\t\t\t\t\t}else if(nr.length == 2){\n\t\t\t\t\t\tif(nr > 12){\n\t\t\t\t\t\t\tday\t= nr;\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t// does not have a value yet\n\t\t\t\t\t\t\tif(month == undefined){\n\t\t\t\t\t\t\t\tmonth\t= nr;\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\tday\t= nr;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tif(day != undefined && month != undefined && year != undefined){\n\t\t\t\t\ttarget.value = `${year}-${month}-${day}`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}else if(target.list != null){\n\t\tlet dataListOption = target.list.querySelector(`[data-value=\"${value}\" i]`);\n\n\t\t//we found a match\n\t\tif(dataListOption != null){\n\t\t\t// We found a cloned field, add as many inputs as needed\n\t\t\tif(target.closest('.clone-div') != null){\n\t\t\t\t// mark the existing ones for deletion, we can delete right now as we need to copy the existing ones first\n\t\t\t\ttarget.closest('.clone-divs-wrapper').querySelectorAll('.clone-div').forEach(el=>el.classList.add('shouldremove'));\n\n\t\t\t\tlet clone;\n\t\t\t\tdataListOption.value.split(';').forEach(val=>{\n\t\t\t\t\tclone = copyFormInput(target.closest('.clone-div'));\n\n\t\t\t\t\tclone.classList.remove('shouldremove');\n\n\t\t\t\t\tchangeFieldValue(clone.querySelector(target.tagName), val, '', form, '', true);\n\t\t\t\t});\n\n\t\t\t\tfixNumbering(target.closest('.clone-divs-wrapper'));\n\n\t\t\t\t// delete the old ones\n\t\t\t\ttarget.closest('.clone-divs-wrapper').querySelectorAll('.shouldremove').forEach(el=>el.remove());\n\t\t\t}else{\n\t\t\t\ttarget.value = dataListOption.value;\n\t\t\t}\n\t\t// We did not find a match, we are filling in the given value\n\t\t}else if(forceValue){\n\t\t\ttarget.value = value;\n\t\t// We did not find a match, empty value\n\t\t}else{\n\t\t\ttarget.value = '';\n\t\t}\n\t}else{\n\t\ttarget.value = value;\n\t}\n\t\n\t//create a new event\n\tlet evt = new Event('input');\n\t//attach the target\n\ttarget.dispatchEvent(evt);\n\t\n\t//run the originating function with this event\n\tif(typeof functionRef == 'function'){\n\t\tfunctionRef(target);\n\t}\n}\n\nexport function changeVisibility(action, el, functionRef){\n\tlet wrapper\t= el.closest('.input-wrapper');\n\tif(wrapper == null){\n\t\twrapper\t= el\n\t}\n\t\n\tif(action == 'add'){\n\t\tif(wrapper.matches('.hidden')){\n\t\t\treturn;\n\t\t}\n\t\twrapper.classList.add('hidden');\n\t}else{\n\t\tif(!wrapper.matches('.hidden')){\n\t\t\treturn;\n\t\t}\n\t\twrapper.classList.remove('hidden');\n\t}\n\n\t//create a new event\n\tlet evt = new Event('input');\n\t//attach the target\n\twrapper.dispatchEvent(evt);\n\t\n\t//run the originating function with this event\n\tif(typeof functionRef == 'function'){\n\t\tfunctionRef(el);\n\t}\n}\n\nexport function changeFieldProperty(selector, att, value, functionRef, form, addition=''){\n\t//first change the value\n\tlet target = form.querySelector(selector);\n\n\t// calculate the new value\n\tif(addition != ''){\n\t\t// check if a date\n\t\tif (/\\d{4}-\\d{2}-\\d{2}/.test(value)){\n\t\t\tlet date\t= new Date(value);\n\t\t\tdate.setDate(date.getDate() + parseInt(addition));\n\t\t\tvalue\t= date.toISOString().split('T')[0];\n\t\t}else{\n\t\t\tvalue\t= value + parseInt(addition);\n\t\t}\n\t}\n\n\ttarget[att] = value;\n\t\n\t//create a new event\n\tlet evt = new Event('input');\n\n\t//attach the target\n\ttarget.dispatchEvent(evt);\n\n\t//run the originating function with this event\n\tfunctionRef(target);\n}","import { cloneNode } from \"../../forms/js/form_exports.js\";\r\n\r\nconsole.log(\"library.js loaded\");\r\n\r\nasync function addBook(target){\r\n\tlet cell\t\t\t= target.closest('td');\r\n\tlet row\t\t\t\t= target.closest('tr');\r\n\tlet formData\t\t= new FormData();\r\n\r\n\trow.querySelectorAll('input, textarea').forEach(input => {\r\n\t\tif(input.type != 'checkbox' || input.checked){\r\n\t\t\tformData.append(input.name, input.value);\r\n\t\t}\r\n\t});\r\n\r\n\trow.querySelectorAll('td > img').forEach(img=>formData.append('image', img.src));\r\n\r\n\ttarget.classList.add('hidden');\r\n\tcell.querySelector(`.loader-wrapper`).classList.remove('hidden');\r\n\r\n\tlet response\t= await FormSubmit.fetchRestApi('library/add_book', formData);\r\n\t\r\n\tif(response){\r\n\t\tcell.innerHTML\t= response;\r\n\r\n\t\tMain.displayMessage(response.message);\r\n\r\n\t\trow.classList.add('processed');\r\n\t}else{\r\n\t\ttarget.classList.remove('hidden');\r\n\t\tcell.querySelector(`.loader-wrapper`).classList.add('hidden');\r\n\r\n\t\ttarget.remove();\r\n\t}\r\n}\r\n\r\nlet fileUploadWrap, totalFiles;\r\nasync function fileUpload(target, location){\r\n\ttotalFiles \t\t= target.files.length;\r\n\r\n\tif (totalFiles < 0){\r\n\t\treturn;\r\n\t}\r\n\t\r\n\t//Create a formData element\r\n\tlet formData = new FormData();\r\n\t\r\n\t//Add the ajax action name\r\n\tformData.append('action', 'process_library_upload');\r\n\r\n\tformData.append('location', location);\r\n\r\n\t//Add all the files to the formData\r\n\tfor (let index = 0; index < totalFiles; index++) {\r\n\t\tlet file\t= target.files[index];\r\n\t\tformData.append('files[]', file);\r\n\t}\r\n\t\r\n\t//AJAX request\r\n\tlet request = new XMLHttpRequest();\r\n\t\r\n\t//Listen to the state changes\r\n\trequest.onreadystatechange = readyStateChanged;\r\n\t\r\n\t//Listen to the upload status\r\n\trequest.upload.addEventListener('progress', fileUploadProgress, false);\r\n\t\r\n\trequest.open('POST', sim.ajaxUrl, true);\r\n\t\r\n\t// Show loading gif\r\n\tfileUploadWrap.querySelectorAll(\".loader-wrapper\").forEach(loader =>{\r\n\t\tloader.classList.remove('hidden');\r\n\t\tloader.querySelectorAll(\".loader-text\").forEach(el =>{\r\n\t\t\tel.textContent = \"Preparing upload\";\r\n\t\t\tel.classList.add('upload-message');\r\n\t\t});\r\n\t});\r\n\t\r\n\t//Send AJAX request\r\n\tfileUploadWrap.querySelector('.loader-text').textContent = \"Uploading Picture(s)\";\r\n\tdocument.getElementById('progress-wrapper').classList.remove('hidden');\r\n\r\n\ttry{\r\n\t\trequest.send(formData);\r\n\t} catch(e){\r\n\t\tconsole.error('Error fetching book data:', e);\r\n\t\tMain.displayMessage(e);\r\n\t}\r\n}\r\n\r\nfunction fileUploadProgress(e){\r\n\tif(e.lengthComputable){\r\n\t\tlet max \t\t= e.total;\r\n\t\tlet current \t= e.loaded;\r\n\r\n\t\tlet percentage \t= (current * 100)/max;\r\n\t\tpercentage \t\t= Math.round(percentage * 10) / 10\r\n\t\t\r\n\t\tdocument.querySelectorAll(\"#upload-progress\").forEach(el=>el.value = percentage);\r\n\t\tdocument.querySelectorAll(\"#progress-percentage\").forEach(el=>el.textContent\t= `   ${percentage}%`);\r\n\r\n\t\tif(percentage >= 99){\r\n\t\t\t//Remove progress barr\r\n\t\t\tdocument.getElementById(\"progress-wrapper\").classList.add('hidden');\r\n\t\t\t\r\n\t\t\t// process completed\r\n\t\t\tfileUploadWrap.querySelectorAll(\".loader-text\").forEach(el =>{\r\n\t\t\t\t//Change message text\r\n\t\t\t\tif (totalFiles > 1){\r\n\t\t\t\t\tel.textContent = \"Processing images\";\r\n\t\t\t\t}else{\r\n\t\t\t\t\tel.textContent = \"Processing image\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}  \r\n}\r\n\r\nfunction readyStateChanged(e){\r\n\tlet request\t= e.target;\r\n\t\r\n\t//If finished\r\n\tif(request.readyState == 4){\r\n\t\t//Success\r\n\t\tif (request.status >= 200 && request.status < 400) {\r\n\t\t\tfileUploadSucces(request.responseText)\r\n\t\t//Error\r\n\t\t}else{\r\n\t\t\tconsole.error(request.responseText);\r\n\t\t\tMain.displayMessage(JSON.parse(request.responseText).error,'error');\r\n\t\t}\r\n\t\t\r\n\t\t//Hide loading gif\r\n\t\tdocument.querySelectorAll(\".loader-wrapper\").forEach(\r\n\t\t\tfunction(loader){\r\n\t\t\t\tloader.classList.add('hidden');\r\n\t\t\t}\r\n\t\t);\r\n\t\t\t\r\n\t\t//Clear the input\r\n\t\tfileUploadWrap.querySelector('input[type=\"file\"]').value = \"\";\r\n\t}\r\n}\r\n\r\nasync function fileUploadSucces(result){\r\n\tlet json\t\t= JSON.parse(result);\r\n\r\n\tif(!json.success){\r\n\t\tMain.displayMessage(`The files failed to process:<br>${json.data[0].message}`, 'error');\r\n\r\n\t\tdocument.querySelectorAll(`.image-selector-wrap.hidden`).forEach(el=>el.classList.remove('hidden'));\r\n\r\n\t\tfileUploadWrap.querySelectorAll('.image-preview').forEach(el => el.remove());\r\n\r\n\t\treturn;\r\n\t}\r\n\r\n\tlet div \t\t= document.createElement('div');\r\n\tdiv.innerHTML\t= json.data;\r\n\tfileUploadWrap.prepend(div);\r\n\r\n\tMain.displayMessage(\"The files have been processed succesfully.\", 'success', true);\r\n\r\n\tfileUploadWrap.querySelector('.image-selector-wrap').classList.remove('hidden');\r\n\r\n\t// Create a custom event so others can listen to it.\r\n\t// Used by formstable uploads\r\n\tconst event = new Event('uploadfinished');\r\n\tfileUploadWrap.dispatchEvent(event);\r\n\r\n\tawait fetchMetaDatas();\r\n\r\n\t// Run this only when all rows are processed\r\n\tSimTableFunctions.setTableLabel();\r\n\r\n\tif(sim.hidden != undefined){\r\n\t\tsim.hidden.forEach(col => SimTableFunctions.hideColumn(div.querySelectorAll(`.sim-table th`)[col]));\r\n\t}\r\n}\r\n\r\nasync function fetchMetaDatas(){\r\n\tlet promiseArray = [];\r\n\r\n\tfileUploadWrap.querySelectorAll('table tr').forEach(async (tr) => {\r\n\t\tpromiseArray.push(fetchMetaData(tr));\r\n\t});\r\n\r\n\tawait Promise.all(promiseArray);\r\n}\r\n\r\nasync function fetchMetaData(tr){\r\n\ttry{\r\n\t\t// Check if a book row\r\n\t\tif(tr.querySelector('.title') == null){\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tlet title\t= tr.querySelector('.title').value;\r\n\r\n\t\t// Only search for the first author\r\n\t\tlet author\t= tr.querySelector('.author').value.trim();\r\n\t\tlet url     = `https://openlibrary.org/search.json?q=`+encodeURIComponent(`title:${title}`);\r\n\t\tif(author != ''){\r\n\t\t\turl += encodeURIComponent(` author:${author}`)+'&limit=1';\r\n\t\t}\r\n\t\turl += '&fields=key,title,author_name,subtitle,alternative_subtitle,cover_i,language,number_of_pages_median,first_publish_year,description,subjects';\r\n\r\n\t\tconst response \t= await fetch(url);\r\n\t\tconst data \t\t= await response.json();\r\n\t\tlet bookData    = data['docs'][0] ?? [];\r\n\r\n\t\t// If no book data found, create a list with possible authors\r\n\t\tif(bookData.length == 0 && author == ''){\r\n\t\t\tlet id\t= `authorlist-${title.replaceAll(\" \", \"_\").replaceAll(\"'\", \"\")}`;\r\n\t\t\ttr.querySelectorAll('.author').forEach(el => el.setAttribute(\"list\", id));\r\n\r\n\t\t\tlet list = `<datalist id='${id}' class='author-selection'>`;\r\n\r\n\t\t\tdata['docs'].forEach((doc) => {\r\n\t\t\t\tif(doc['author_name'] != undefined){\r\n\t\t\t\t\tlist += `<option value='${doc['author_name'].join()}'>`;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tlist += `</datalist>`;\r\n\t\t\ttr.querySelector('.authors').insertAdjacentHTML('afterEnd', list);\r\n\t\t}else{\r\n\t\t\tlet authors \t= bookData['author_name'] ?? [author];\r\n\t\t\tlet wrapper \t= tr.querySelector(`.authors.clone-divs-wrapper`);\r\n\t\t\tlet baseElement = wrapper.querySelector(`.clone-div`);\r\n\r\n\t\t\tauthors.forEach(author => {\r\n\t\t\t\tlet clone\t\t= cloneNode(baseElement);\r\n\t\t\t\tclone.querySelector('.author').value = author;\r\n\r\n\t\t\t\twrapper.appendChild(clone);\r\n\t\t\t});\t\t\r\n\t\t\t\r\n\t\t\tbaseElement.remove()\r\n\t\t}\r\n\r\n\t\tlet image        = bookData['cover_i'] ?? '';\r\n        if(image != ''){\r\n           \tlet  smallUrl    = `https://covers.openlibrary.org/b/id/${image}-S.jpg`;\r\n\t\t   \tlet  largeUrl    = `https://covers.openlibrary.org/b/id/${image}-L.jpg`;\r\n\r\n\t\t\ttr.querySelector('.image').innerHTML = `<input type='hidden' class='no-reset' name='image' value='${image}'><a href='${largeUrl}' target='_blank'><img src='${smallUrl}' class='book-image' loading='lazy'></a>`;\r\n        }\r\n\r\n\t\tlet subtitle\t= bookData['subtitle'] ?? '';\r\n\r\n\t\tlet year\t\t= bookData['first_publish_year'] ?? '';\r\n\t\tyear\t\t\t= year[0] ?? year;\r\n\r\n\t\tlet language\t= bookData['language'] ?? '';\r\n\t\tlanguage\t\t= language[0] ?? language;\r\n\r\n\t\tlet pageCount\t\t= bookData['number_of_pages'] ?? bookData['number_of_pages_median'] ?? '';\r\n\r\n\t\tlet html = `<td><input type='text' name='subtitle' class='subtitle' value='${subtitle}'></td>`;\r\n\t\thtml += `<td><input type='text' name='series' class='series' value='${bookData['series'] ?? ''}'></td>`;\r\n\t\thtml += `<td><input type='text' name='year' class='year' value='${year}'></td>`;\r\n\t\thtml += `<td><input type='text' name='language' class='language' value='${language}'></td>`;\r\n\t\thtml += `<td><input type='text' name='pages' class='pages' value='${pageCount}'></td>`;\r\n\r\n\t\tlet placeholder\t= tr.querySelector('.placeholder');\r\n\t\tif(placeholder == null){\r\n\t\t\ttr.querySelector('.subtitle').value = subtitle;\r\n\t\t\ttr.querySelector('.series').value \t= bookData['series'] ?? '';\r\n\t\t\ttr.querySelector('.year').value \t= year;\r\n\t\t\ttr.querySelector('.language').value = language;\r\n\t\t\ttr.querySelector('.pages').value \t= pageCount;\r\n\t\t}else{\r\n\t\t\tplaceholder.outerHTML = html;\r\n\t\t}\r\n\r\n        let description\t= tr.querySelector('.description').value\r\n\t\tdescription\t\t= bookData['description'] != undefined ? bookData['description']['value'] != undefined ? bookData['description']['value'] : '' : '';\r\n\r\n\t\tlet key        \t= bookData['key'] ?? '';\r\n\t\tlet workJson\t= '';\r\n        if(key != ''){\r\n            url      = `https://openlibrary.org${key}`;\r\n\t\t\ttr.querySelector('.url').innerHTML = `\r\n\t\t\t<input type='hidden' class='no-reset' name='url' value='${url}'>\r\n\t\t\t<a href='${url}' target='_blank'>View on Open Library</a>\r\n\t\t\t`;\r\n\r\n\t\t\t// Fetch the summary from the Open Library API\r\n\t\t\tconst workResponse \t= await fetch(url+'.json');\r\n\t\t\tworkJson \t\t\t= await workResponse.json();\r\n\r\n\t\t\tdescription \t\t= workJson['description'] ?? '';\t\r\n\t\t\t\r\n\t\t\tdescription \t\t= description.value ?? description;\r\n\r\n\t\t\tif(\tworkJson['subjects'] != undefined ){\r\n\t\t\t\tworkJson['subjects'].forEach((subject) => {\r\n\t\t\t\t\ttr.querySelectorAll(`.category-select [data-name=\"${subject}\"]`).forEach((el) => el.checked = true);\r\n\t\t\t\t});\r\n\t\t\t}\r\n        }\r\n\r\n\t\tif(description != ''){\r\n\t\t\ttr.querySelector('.description').value = description;\r\n\t\t}\r\n\r\n\t\t// add book automatically if there is a picture and description\r\n\t\tif(image != '' && key != '' && typeof(workJson) != 'undefined' && workJson['subjects'] != undefined){\r\n\t\t\ttr.querySelector('.add-book').click();\r\n\t\t}\r\n\t} catch(e){\r\n\t\tconsole.error('Error fetching book data:', e);\r\n\t}\r\n}\r\n\r\nfunction hideCss(type){\r\n\tlet style = document.createElement('style');\r\n\tstyle.innerHTML = `.${type} { display: none; }`;\r\n\tdocument.getElementsByTagName('head')[0].appendChild(style);\r\n\r\n\tconst url \t\t= new URL(window.location);\r\n\turl.searchParams.set('hide', type);\r\n}\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", function() {\r\n\t\r\n\r\n});\r\n\r\ndocument.addEventListener(\"click\", event =>{\r\n\tlet target = event.target;\r\n\r\n\tif(fileUploadWrap != undefined && target.matches(`.add-books`)){\r\n\t\tfileUploadWrap.querySelectorAll('.image-preview, .book.table-wrapper').forEach(el => el.remove());\r\n\t}else if(target.matches(`.add-book`)){\r\n\t\taddBook(target);\r\n\t}else if(target.matches(`.delete-book`)){\r\n\t\ttarget.closest('tr').remove();\r\n\t}else if(target.matches('.hide-existing-books')){\r\n\t\thideCss('existing-book');\r\n\t\ttarget.remove();\r\n\t}else if(target.matches('.hide-processed-books')){\r\n\t\thideCss('processed');\r\n\t\ttarget.remove();\r\n\t}else{\r\n\t\treturn;\r\n\t}\r\n\r\n\tevent.stopImmediatePropagation();\r\n});\r\n\r\ndocument.addEventListener(\"change\", async event =>{\r\n\tlet target = event.target;\r\n\r\n\tif(target.name == 'image-selector' && target.files.length > 0){\r\n\t\tfileUploadWrap\t= target.closest('.file-upload-wrap');\r\n\r\n\t\t// Remove the old table if any\r\n\t\tfileUploadWrap.querySelectorAll('.image-preview, .book.table-wrapper').forEach(el => el.remove());\r\n\t\t\r\n\t\t// Make sure we have a location\r\n\t\tlet location\t= fileUploadWrap.querySelector(`.book-location`);\r\n\t\tconst isValid \t= location.reportValidity();\r\n\t\tif (!isValid) {\t\t\t\r\n\t\t\ttarget.value = '';\r\n\t\t\tMain.displayMessage(\"Please select a location for the book.\", 'error');\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tlocation = location.value;\r\n\t\t\r\n\t\t// Remove previous result tables\r\n\t\tdocument.querySelectorAll('.book-table-wrapper').forEach(el => el.remove());\r\n\t\t\r\n\t\ttarget.closest('.image-selector-wrap').classList.add('hidden');\r\n\t\tfileUploadWrap.querySelectorAll('.image-preview').forEach(el => el.remove());\r\n\t\t\r\n\t\tfor (const file of target.files) {\r\n\t\t\tlet reader = new FileReader();\r\n\r\n\t\t\treader.onload = function(e) {\r\n\t\t\t\tlet div \t\t\t= document.createElement('div');\r\n\t\t\t\tdiv.classList.add('image-preview');\r\n\t\t\t\tdiv.style.textAlign\t= 'center';\r\n\r\n\t\t\t\tlet img \t\t\t= document.createElement('img');\r\n\t\t\t\timg.src \t\t\t= e.target.result;\r\n\t\t\t\timg.classList.add('book-image');\r\n\t\t\t\timg.style.maxHeight\t= \"100px\";\r\n\t\t\t\timg.style.padding\t=  \"0\";\r\n\r\n\t\t\t\tdiv.appendChild(img);\r\n\t\t\t\t\r\n\t\t\t\tfileUploadWrap.prepend(div);\r\n\t\t\t}\r\n\t\t\treader.readAsDataURL(file);\r\n\r\n\t\t\tfileUpload(target, location);\r\n\t\t}\r\n\t}else if(target.matches('.title, .author')){\r\n\t\tlet tr = target.closest('tr');\r\n\r\n\t\ttr.style.position = 'relative';\r\n\r\n\t\tlet loader = Main.showLoader(tr.lastChild, false, tr.offsetHeight - 100, 'Updating book data...');\r\n\r\n\t\tloader.style.position \t\t\t= 'absolute';\r\n\t\tloader.style.top\t\t\t\t= 0;\r\n\t\tloader.style.left\t\t\t\t= 0;\r\n\t\tloader.style.width\t\t\t\t= '100vw';\r\n\t\tloader.style.height\t\t\t\t= '100%';\r\n\t\tloader.style.backgroundColor\t= 'rgba(0, 0, 0, 0.5)';\r\n\t\tloader.style.color\t\t\t\t= 'white';\r\n\t\tloader.style.display\t\t\t= 'flex';\r\n\t\tloader.style.justifyContent\t\t= 'center';\r\n\t\tloader.style.alignItems\t\t\t= 'center';\r\n\t\t\r\n\t\t// Update metadata for the book row\r\n\t\tawait fetchMetaData(tr);\r\n\r\n\t\tloader.remove();\r\n\t}else{\r\n\t\treturn;\r\n\t}\r\n\r\n\tevent.stopImmediatePropagation();\r\n});"],"names":["removeDefaultSelect","el","Array","from","options","forEach","option","defaultSelected","fileUploadWrap","totalFiles","tinymceSettings","async","target","location","files","length","formData","FormData","append","index","file","request","XMLHttpRequest","onreadystatechange","readyStateChanged","upload","addEventListener","fileUploadProgress","open","sim","ajaxUrl","querySelectorAll","loader","classList","remove","textContent","add","querySelector","document","getElementById","send","e","console","error","Main","displayMessage","lengthComputable","max","total","percentage","loaded","Math","round","value","readyState","status","result","json","JSON","parse","success","data","message","div","createElement","innerHTML","prepend","event","Event","dispatchEvent","promiseArray","tr","push","fetchMetaData","Promise","all","fetchMetaDatas","SimTableFunctions","setTableLabel","undefined","hidden","col","hideColumn","fileUploadSucces","responseText","title","author","trim","url","encodeURIComponent","response","fetch","bookData","id","replaceAll","setAttribute","list","doc","join","insertAdjacentHTML","authors","wrapper","baseElement","clone","originalNode","clear","tn","tinymce","get","settings","save","prepareForCloning","newNode","cloneNode","dropdown","init","input","type","checked","matches","select","attachNiceSelect","appendChild","image","smallUrl","largeUrl","subtitle","year","language","pageCount","html","placeholder","outerHTML","description","key","workJson","workResponse","subject","click","hideCss","style","getElementsByTagName","URL","window","searchParams","set","log","cell","closest","row","name","img","src","FormSubmit","fetchRestApi","addBook","stopImmediatePropagation","reportValidity","reader","FileReader","onload","textAlign","maxHeight","padding","readAsDataURL","position","showLoader","lastChild","offsetHeight","top","left","width","height","backgroundColor","color","display","justifyContent","alignItems"],"sourceRoot":""}