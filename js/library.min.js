(()=>{"use strict";function e(e){Array.from(e.options).forEach(function(e){e.defaultSelected=!1})}let t,l,a,r=[];function o(e){null!=e.target.closest("td")&&e.target.closest("td").matches(".editing")||(e.stopPropagation(),document.removeEventListener("click",o),s(e,document.querySelector(".editing input, .editing select, .editing textarea")))}function n(e){e.closest("td").classList.add("editing"),t=e.textContent,"Click to update"!=t&&"X"!=t||(t=""),e.innerHTML=`<input type="text" value="${t}">`,function(e){let l=e.querySelectorAll("input,select,textarea");l.forEach(e=>{t.split(",").forEach(l=>{"checkbox"==e.type||"radio"==e.type?e.value==l.trim()&&(e.checked=!0):"select"==e.type?e.querySelector('option[value="'+l+'"]').selected=!0:e.value=t}),"select-one"==e.type&&null==e._niceSelect&&Main.attachNiceSelect(e),e.addEventListener("keyup",function(e){13===e.keyCode&&s(e)}),document.addEventListener("click",o),"checkbox"==e.type&&1!=l.length||("date"==e.type?e.addEventListener("blur",function(e){""!=e.target.value&&s(e)}):e.addEventListener("change",function(e){""!=e.target.value&&s(e)}),e.focus())})}(e)}async function s(e,l){void 0===l&&(l=e.target);let a=l.closest("td"),r=function(e,t,l=!0,a=null,r=!1){let o="",n="",s="",c="";return e instanceof Element?(o=e,"INPUT"!=o.tagName&&"TEXTAREA"!=o.tagName&&"SELECT"!=o.tagName&&null==o.closest(".nice-select-dropdown")&&(o=o.querySelector("input, select, textarea")),null==o&&(o=e),n=o.name):e.match("E[0-9]")?(c=`[id^=${e}]`,o=t.querySelector(c),n=o.name):(n=e,c=`[name='${n}' i]`,o=t.querySelector(c)),null==o?(console.trace(),console.log("cannot find element with name "+n),s):("radio"==o.type?s=function(e,t){let l=e.querySelector(`${t}:checked`);return null==l?"":l.value}(t,c):"checkbox"==o.type?s=function(e,t,l,a){let r="",o="";return"checkbox"==a.type&&null!=l?a.checked?a.value:"":(null!=l?(o=e.querySelector(`${t}[value="${l}" i]:checked`),null!=o&&(r=l)):(o=e.querySelectorAll(`${t}:checked`),r=[],o.forEach(e=>{r.push(e.value)})),r)}(t,c,a,e):null!=o.closest(".nice-select-dropdown")&&null!=o.dataset.value?s=o.dataset.value:null!=o.list&&""!=o.value&&l?s=function(e){let t="",l=e.list.querySelector(`[value='${e.value}' i]`);return t=null==l?e.value:l.dataset.value,t}(o):null!=o.name&&o.name.endsWith("[]")?s=function(e,t){let l=[];return e.querySelectorAll(`[name="${t.name}"]`).forEach(e=>l.push(e.value)),l}(t,o):null!=o.value&&"undefined"!=o.value&&(s=o.value),r?s.toLowerCase():s)}(l,a,!1),o=l.closest("table");if(r!=t){let e=new FormData;e.append("value",JSON.stringify(r));for(let t in a.dataset)e.append(t,a.dataset[t]);for(let t in l.closest("tr").dataset)e.append(t,l.closest("tr").dataset[t]);Main.showLoader(a.firstChild),await FormSubmit.fetchRestApi(o.dataset.url,e)&&(a.innerHTML=r)}else console.log(r),l.closest("td").innerHTML=t;a.classList.remove("editing")}function c(){document.querySelectorAll(".sim-table").forEach(function(e){let t=[];e.querySelectorAll("thead th").forEach((e,l)=>{null!=e.dataset.nicename?t[l]=e.dataset.nicename:t[l]=e.textContent}),e.querySelectorAll("tbody td").forEach(e=>{e.hasAttribute("label")||null==t[e.cellIndex]||e.setAttribute("label",t[e.cellIndex]),"X"!=e.textContent&&""!=e.textContent||e.classList.add("mobile-hidden")})})}async function i(e){e.textContent="Close full screen",e.classList.replace("show","close");let t=e.closest(".table-wrapper");window.lastY=window.pageYOffset,window.scrollTo(0,0),document.querySelector("body").style.overflow="hidden",document.querySelector("header").style.zIndex="unset",t.classList.add("fullscreen"),t.style.marginLeft="0px";let l=new URL(window.location);l.searchParams.set("fullscreen",t.querySelector("table").dataset.formid),window.history.pushState({},"",l),d(),t.requestFullscreen().catch(e=>{})}function d(){let e,t,l=new URLSearchParams(window.location.search).get("fullscreen");document.querySelectorAll(".sim-table").forEach(a=>{let r=a.closest(".table-wrapper");if(null==r)return;null!=l?(t=0,r.querySelectorAll(".table-head").forEach(e=>t=e.offsetHeight)):t=document.querySelector("header").offsetHeight,e=0,r.querySelectorAll(".sim-table-footer").forEach(t=>e=t.offsetHeight);let o=t+e+40;a.style.maxHeight=`calc(100vh - ${o}px)`})}function u(){document.querySelectorAll(".table-wrapper").forEach(e=>{let t="",l=0,a=e.querySelector("table");if(null==a)return;let r=a.scrollWidth;if(0!=r){if(window.innerWidth<570)t=e.getBoundingClientRect().x;else{let a=window.innerWidth-r;r/window.innerWidth<.7?null!=document.querySelector(".is-right-sidebar")&&(a=.7*window.innerWidth-r):(document.getElementById("primary").style.zIndex=1,document.querySelectorAll("#right-sidebar").forEach(e=>e.style.zIndex=0)),l=a<20?10:a/2,""!=e.style.marginLeft&&(e.style.marginLeft="-0px"),t=parseInt(e.getBoundingClientRect().x)-l}e.style.marginLeft=`-${t}px`}})}async function p(e,t){if(a=e.files.length,a<0)return;let r=new FormData;r.append("action","process_library_upload"),r.append("location",t);for(let t=0;t<a;t++){let l=e.files[t];r.append("files[]",l)}let o=new XMLHttpRequest;o.onreadystatechange=m,o.upload.addEventListener("progress",h,!1),o.open("POST",sim.ajaxUrl,!0),l.querySelectorAll(".loader_wrapper").forEach(e=>{e.classList.remove("hidden"),e.querySelectorAll(".uploadmessage").forEach(e=>{e.textContent="Preparing upload",e.classList.add("upload-message")})}),l.querySelector(".uploadmessage").textContent="Uploading Picture(s)",document.getElementById("progress-wrapper").classList.remove("hidden"),o.send(r)}function h(e){if(e.lengthComputable){let t=e.total,r=100*e.loaded/t;r=Math.round(10*r)/10,document.querySelectorAll("#upload_progress").forEach(e=>e.value=r),document.querySelectorAll("#progress_percentage").forEach(e=>e.textContent=`   ${r}%`),r>=99&&(document.getElementById("progress-wrapper").classList.add("hidden"),l.querySelectorAll(".uploadmessage").forEach(e=>{e.textContent=a>1?"Processing images":"Processing image"}))}}function m(e){let t=e.target;4==t.readyState&&(t.status>=200&&t.status<400?async function(e){let t=document.createElement("div");t.innerHTML=JSON.parse(e).data,l.prepend(t),Main.displayMessage("The files have been processed succesfully.","success",!0),l.querySelector(".image-selector-wrap").classList.remove("hidden");const a=new Event("uploadfinished");l.dispatchEvent(a),await async function(){let e=[];l.querySelectorAll("table tr").forEach(async t=>{e.push(y(t))}),await Promise.all(e)}(),c()}(t.responseText):(console.error(t.responseText),Main.displayMessage(JSON.parse(t.responseText).error,"error")),document.querySelectorAll(".loader_wrapper").forEach(function(e){e.classList.add("hidden")}),l.querySelector('input[type="file"]').value="")}async function y(t){try{if(null==t.querySelector(".title"))return;let l=t.querySelector(".title").value,a=t.querySelector(".author").value.trim(),o="https://openlibrary.org/search.json?q="+encodeURIComponent(`title:${l}`);""!=a&&(o+=encodeURIComponent(` author:${a}`)+"&limit=1"),o+="&fields=key,title,author_name,subtitle,alternative_subtitle,cover_i,language,number_of_pages_median,first_publish_year,description,subjects";const n=await fetch(o),s=await n.json();let c=s.docs[0]??[];if(0==c.length&&""==a){let e=`authorlist-${l.replaceAll(" ","_").replaceAll("'","")}`;t.querySelectorAll(".author").forEach(t=>t.setAttribute("list",e));let a=`<datalist id='${e}' class='author-selection'>`;s.docs.forEach(e=>{null!=e.author_name&&(a+=`<option value='${e.author_name.join()}'>`)}),a+="</datalist>",t.querySelector(".authors").insertAdjacentHTML("afterEnd",a)}else{let l=c.author_name??[a],o=t.querySelector(".authors.clone_divs_wrapper"),n=o.querySelector(".clone_div");l.forEach(t=>{let l=function(t,l=!0){!function(e){"undefined"!=typeof tinymce&&e.querySelectorAll(".wp-editor-area").forEach(e=>{let t=tinymce.get(e.id);null!=t&&(r[e.id]=t.settings,t.save(),t.remove())})}(t);let a=t.cloneNode(!0);return a.querySelectorAll(".nice-select").forEach(e=>e.remove()),t.querySelectorAll(".wp-editor-area").forEach(e=>{null!=r[e.id]&&tinymce.init(r[e.id])}),l&&a.querySelectorAll("input,select,textarea").forEach(t=>{"checkbox"==t.type||"radio"==t.type?t.checked=!1:"hidden"!=t.type&&(t.value=""),"select-one"==t.type&&e(t)}),a.querySelectorAll("select").forEach(t=>{e(t),Main.attachNiceSelect(t)}),a}(n);l.querySelector(".author").value=t,o.appendChild(l)}),n.remove()}let i=c.cover_i??"";if(""!=i){let e=`https://covers.openlibrary.org/b/id/${i}-S.jpg`,l=`https://covers.openlibrary.org/b/id/${i}-L.jpg`;t.querySelector(".image").innerHTML=`<input type='hidden' name='image' value='${i}'><a href='${l}' target='_blank'><img src='${e}' class='book-image' loading='lazy'></a>`}let d=c.subtitle??"",u=c.first_publish_year??"";u=u[0]??u;let p=c.language??"";p=p[0]??p;let h=c.number_of_pages??c.number_of_pages_median??"",m=`<td><input type='text' name='subtitle' class='subtitle' value='${d}'></td>`;m+=`<td><input type='text' name='series' class='series' value='${c.series??""}'></td>`,m+=`<td><input type='text' name='year' class='year' value='${u}'></td>`,m+=`<td><input type='text' name='language' class='language' value='${p}'></td>`,m+=`<td><input type='text' name='pages' class='pages' value='${h}'></td>`;let y=t.querySelector(".placeholder");null==y?(t.querySelector(".subtitle").value=d,t.querySelector(".series").value=c.series??"",t.querySelector(".year").value=u,t.querySelector(".language").value=p,t.querySelector(".pages").value=h):y.outerHTML=m;let f=t.querySelector(".description").value;f=null!=c.description&&null!=c.description.value?c.description.value:"";let g=c.key??"";if(""!=g){o=`https://openlibrary.org${g}`,t.querySelector(".url").innerHTML=`\n\t\t\t<input type='hidden' name='url' value='${o}'>\n\t\t\t<a href='${o}' target='_blank'>View on Open Library</a>\n\t\t\t`;const e=await fetch(o+".json"),l=await e.json();f=l.description??"",f=f.value??f,null!=l.subjects&&l.subjects.forEach(e=>{t.querySelectorAll(`.category-select [data-name="${e}"]`).forEach(e=>e.checked=!0)})}""!=f&&(t.querySelector(".description").value=f),""!=i&&""!=g&&"undefined"!=typeof workJson&&null!=workJson.subjects&&t.querySelector(".add-book").click()}catch(e){console.error("Error fetching book data:",e)}}function f(e){let t=document.createElement("style");t.innerHTML=`.${e} { display: none; }`,document.getElementsByTagName("head")[0].appendChild(t),new URL(window.location).searchParams.set("hide",e)}console.log("Table.js loaded"),document.addEventListener("click",e=>{let t=e.target;"TH"==t.tagName&&function(e){let t,l,a,r=e.closest("table"),o=!0;var n="asc";for(e.classList.contains("desc")&&(n="desc");o;){o=!1,a=r.rows;for(let r=1;r<a.length-1;r++){if(t=a[r].getElementsByTagName("TD")[e.cellIndex].innerHTML.toLowerCase(),l=a[r+1].getElementsByTagName("TD")[e.cellIndex].innerHTML.toLowerCase(),isNaN(t)||isNaN(l)){let e=new Date(t),a=new Date(l);"Invalid Date"===e||isNaN(e)||70==e.getYear()||"Invalid Date"===a||isNaN(a)||70==a.getYear()||(t=e.getTime(),l=a.getTime())}else t=parseFloat(t),l=parseFloat(l);("asc"==n&&t>l||"desc"==n&&l>t)&&(a[r].parentNode.insertBefore(a[r+1],a[r]),o=!0)}}"asc"==n?(e.classList.add("desc"),e.classList.replace("asc","desc")):e.classList.replace("desc","asc")}(t);let l=t.closest("td");t.matches("td.edit")?(e.stopPropagation(),n(t)):null!=l&&l.matches("td.edit")&&"INPUT"!=t.tagName&&"A"!=t.tagName&&"TEXTAREA"!=t.tagName&&!t.closest(".nice-select")?(e.stopPropagation(),n(t.closest("td"))):t.matches(".show.fullscreenbutton")?i(t):t.matches(".close.fullscreenbutton")?function(e){let t=100;e.textContent="Show full screen",e.classList.replace("close","show"),null!=window.lastY&&(t=window.lastY),window.scrollTo(0,t),console.log("scrolling"),document.querySelector("body").style.overflow="unset",document.querySelector("header").style.zIndex="99999",e.closest(".table-wrapper").classList.remove("fullscreen"),u();let l=new URL(window.location);l.searchParams.delete("fullscreen"),window.history.pushState({},"",l),document.exitFullscreen(),d()}(t):t.classList.contains("visibilityicon")?(async e=>{if("SPAN"==e.tagName&&(e=e.querySelector("img")),e.parentNode.matches("th")){let l=e.parentNode;var t=l.closest("table").rows;for(const e of t)e.cells[l.cellIndex].classList.add("hidden");l.closest(".table-wrapper").querySelectorAll(".reset-col-vis").forEach(e=>e.classList.remove("hidden"))}})(t):t.matches(".reset-col-vis")&&async function(e){e.closest(".table-wrapper").querySelector(".reset-col-vis").classList.add("hidden"),e.closest(".form.table-wrapper").querySelector("table").querySelectorAll("th.hidden, td.hidden").forEach(e=>e.classList.remove("hidden"))}(t)}),document.addEventListener("DOMContentLoaded",function(){u(),window.addEventListener("resize",u),c();let e=new URLSearchParams(window.location.search).get("fullscreen");if(null!=e)try{i(document.querySelector(`table[data-formid="${e}"]`).closest(".table-wrapper").querySelector(".fullscreenbutton"))}catch{console.error(`table[data-formid="${e}"]`)}d()}),console.log("library.js loaded"),document.addEventListener("DOMContentLoaded",function(){}),document.addEventListener("click",e=>{let t=e.target;null!=l&&t.matches(".add-books")?l.querySelectorAll(".image-preview, .book.table-wrapper").forEach(e=>e.remove()):t.matches(".add-book")?async function(e){let t=e.closest("td"),l=e.closest("tr"),a=new FormData;l.querySelectorAll("input, textarea").forEach(e=>{("checkbox"!=e.type||e.checked)&&a.append(e.name,e.value)}),l.querySelectorAll("td > img").forEach(e=>a.append("image",e.src)),e.classList.add("hidden"),t.querySelector(".loader_wrapper").classList.remove("hidden");let r=await FormSubmit.fetchRestApi("library/add_book",a);r?(t.innerHTML=r,Main.displayMessage(r.message),l.classList.add("processed")):(e.classList.remove("hidden"),t.querySelector(".loader_wrapper").classList.add("hidden"),e.remove())}(t):t.matches(".delete-book")?t.closest("tr").remove():t.matches(".hide-existing-books")?(f("existing-book"),t.remove()):t.matches(".hide-processed-books")&&(f("processed"),t.remove())}),document.addEventListener("change",async e=>{let t=e.target;if("image-selector"==t.name&&t.files.length>0){l=t.closest(".file_upload_wrap"),l.querySelectorAll(".image-preview, .book.table-wrapper").forEach(e=>e.remove());let e=l.querySelector(".book-location");if(!e.reportValidity())return t.value="",void Main.displayMessage("Please select a location for the book.","error");e=e.value,document.querySelectorAll(".book-table-wrapper").forEach(e=>e.remove()),t.closest(".image-selector-wrap").classList.add("hidden"),l.querySelectorAll(".image-preview").forEach(e=>e.remove());for(const a of t.files){let r=new FileReader;r.onload=function(e){let t=document.createElement("div");t.classList.add("image-preview");let a=document.createElement("img");a.src=e.target.result,a.classList.add("book-image"),a.style.maxHeight="100px",a.style.padding="0",t.appendChild(a),l.prepend(t)},r.readAsDataURL(a),p(t,e)}}else if(t.matches(".title, .author")){let e=t.closest("tr");e.style.position="relative";let l=function(e,t=!0){if(null==e)return;let l=document.createElement("DIV");if(l.innerHTML=sim.loaderHtml,t)e.parentNode.replaceChild(l,e);else{let t=e.nextElementSibling;null==t?e.parentNode.insertAdjacentElement("beforeEnd",l):e.parentNode.insertBefore(l,t)}return l}(e.firstChild,!1);l.style.position="absolute",l.style.top=0,l.style.left=0,l.style.width="100%",l.style.height="100%",l.style.backgroundColor="rgba(0, 0, 0, 0.7)",l.style.color="white",l.style.opacity=.5,l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",await y(e),l.remove()}})})();
//# sourceMappingURL=library.min.js.map