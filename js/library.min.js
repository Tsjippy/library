(()=>{"use strict";function e(e){Array.from(e.options).forEach(function(e){e.defaultSelected=!1})}let t,r,a=[];async function l(e,a){if(r=e.files.length,r<0)return;let l=new FormData;l.append("action","process_library_upload"),l.append("location",a);for(let t=0;t<r;t++){let r=e.files[t];l.append("files[]",r)}let n=new XMLHttpRequest;n.onreadystatechange=s,n.upload.addEventListener("progress",o,!1),n.open("POST",sim.ajaxUrl,!0),t.querySelectorAll(".loader-wrapper").forEach(e=>{e.classList.remove("hidden"),e.querySelectorAll(".loader-text").forEach(e=>{e.textContent="Preparing upload",e.classList.add("upload-message")})}),t.querySelector(".loader-text").textContent="Uploading Picture(s)",document.getElementById("progress-wrapper").classList.remove("hidden");try{n.send(l)}catch(e){console.error("Error fetching book data:",e),Main.displayMessage(e)}}function o(e){if(e.lengthComputable){let a=e.total,l=100*e.loaded/a;l=Math.round(10*l)/10,document.querySelectorAll("#upload-progress").forEach(e=>e.value=l),document.querySelectorAll("#progress-percentage").forEach(e=>e.textContent=`   ${l}%`),l>=99&&(document.getElementById("progress-wrapper").classList.add("hidden"),t.querySelectorAll(".loader-text").forEach(e=>{e.textContent=r>1?"Processing images":"Processing image"}))}}function s(e){let r=e.target;4==r.readyState&&(r.status>=200&&r.status<400?async function(e){let r=JSON.parse(e);if(!r.success)return Main.displayMessage(`The files failed to process:<br>${r.data[0].message}`,"error"),document.querySelectorAll(".image-selector-wrap.hidden").forEach(e=>e.classList.remove("hidden")),void t.querySelectorAll(".image-preview").forEach(e=>e.remove());let a=document.createElement("div");a.innerHTML=r.data,t.prepend(a),Main.displayMessage("The files have been processed succesfully.","success",!0),t.querySelector(".image-selector-wrap").classList.remove("hidden");const l=new Event("uploadfinished");t.dispatchEvent(l),await async function(){let e=[];t.querySelectorAll("table tr").forEach(async t=>{e.push(n(t))}),await Promise.all(e)}(),SimTableFunctions.setTableLabel(),null!=sim.hidden&&sim.hidden.forEach(e=>SimTableFunctions.hideColumn(a.querySelectorAll(".sim-table th")[e]))}(r.responseText):(console.error(r.responseText),Main.displayMessage(JSON.parse(r.responseText).error,"error")),document.querySelectorAll(".loader-wrapper").forEach(function(e){e.classList.add("hidden")}),t.querySelector('input[type="file"]').value="")}async function n(t){try{if(null==t.querySelector(".title"))return;let r=t.querySelector(".title").value,l=t.querySelector(".author").value.trim(),o="https://openlibrary.org/search.json?q="+encodeURIComponent(`title:${r}`);""!=l&&(o+=encodeURIComponent(` author:${l}`)+"&limit=1"),o+="&fields=key,title,author_name,subtitle,alternative_subtitle,cover_i,language,number_of_pages_median,first_publish_year,description,subjects";const s=await fetch(o),n=await s.json();let i=n.docs[0]??[];if(0==i.length&&""==l){let e=`authorlist-${r.replaceAll(" ","_").replaceAll("'","")}`;t.querySelectorAll(".author").forEach(t=>t.setAttribute("list",e));let a=`<datalist id='${e}' class='author-selection'>`;n.docs.forEach(e=>{null!=e.author_name&&(a+=`<option value='${e.author_name.join()}'>`)}),a+="</datalist>",t.querySelector(".authors").insertAdjacentHTML("afterEnd",a)}else{let r=i.author_name??[l],o=t.querySelector(".authors.clone-divs-wrapper"),s=o.querySelector(".clone-div");r.forEach(t=>{let r=function(t,r=!0){!function(e){"undefined"!=typeof tinymce&&e.querySelectorAll(".wp-editor-area").forEach(e=>{let t=tinymce.get(e.id);null!=t&&(a[e.id]=t.settings,t.save(),t.remove())})}(t);let l=t.cloneNode(!0);return l.querySelectorAll(".nice-select").forEach(e=>e.remove()),t.querySelectorAll(".wp-editor-area").forEach(e=>{null!=a[e.id]&&tinymce.init(a[e.id])}),r&&l.querySelectorAll("input,select,textarea").forEach(t=>{"checkbox"==t.type||"radio"==t.type?t.checked=!1:t.matches(".no-reset")||(t.value=""),"select-one"==t.type&&e(t)}),l.querySelectorAll("select").forEach(t=>{e(t),Main.attachNiceSelect(t)}),l}(s);r.querySelector(".author").value=t,o.appendChild(r)}),s.remove()}let c=i.cover_i??"";if(""!=c){let e=`https://covers.openlibrary.org/b/id/${c}-S.jpg`,r=`https://covers.openlibrary.org/b/id/${c}-L.jpg`;t.querySelector(".image").innerHTML=`<input type='hidden' class='no-reset' name='image' value='${c}'><a href='${r}' target='_blank'><img src='${e}' class='book-image' loading='lazy'></a>`}let d=i.subtitle??"",u=i.first_publish_year??"";u=u[0]??u;let p=i.language??"";p=p[0]??p;let y=i.number_of_pages??i.number_of_pages_median??"",h=`<td><input type='text' name='subtitle' class='subtitle' value='${d}'></td>`;h+=`<td><input type='text' name='series' class='series' value='${i.series??""}'></td>`,h+=`<td><input type='text' name='year' class='year' value='${u}'></td>`,h+=`<td><input type='text' name='language' class='language' value='${p}'></td>`,h+=`<td><input type='text' name='pages' class='pages' value='${y}'></td>`;let m=t.querySelector(".placeholder");null==m?(t.querySelector(".subtitle").value=d,t.querySelector(".series").value=i.series??"",t.querySelector(".year").value=u,t.querySelector(".language").value=p,t.querySelector(".pages").value=y):m.outerHTML=h;let f=t.querySelector(".description").value;f=null!=i.description&&null!=i.description.value?i.description.value:"";let g=i.key??"",v="";if(""!=g){o=`https://openlibrary.org${g}`,t.querySelector(".url").innerHTML=`\n\t\t\t<input type='hidden' class='no-reset' name='url' value='${o}'>\n\t\t\t<a href='${o}' target='_blank'>View on Open Library</a>\n\t\t\t`;const e=await fetch(o+".json");v=await e.json(),f=v.description??"",f=f.value??f,null!=v.subjects&&v.subjects.forEach(e=>{t.querySelectorAll(`.category-select [data-name="${e}"]`).forEach(e=>e.checked=!0)})}""!=f&&(t.querySelector(".description").value=f),""!=c&&""!=g&&void 0!==v&&null!=v.subjects&&t.querySelector(".add-book").click()}catch(e){console.error("Error fetching book data:",e)}}function i(e){let t=document.createElement("style");t.innerHTML=`.${e} { display: none; }`,document.getElementsByTagName("head")[0].appendChild(t),new URL(window.location).searchParams.set("hide",e)}console.log("library.js loaded"),document.addEventListener("DOMContentLoaded",function(){}),document.addEventListener("click",e=>{let r=e.target;if(null!=t&&r.matches(".add-books"))t.querySelectorAll(".image-preview, .book.table-wrapper").forEach(e=>e.remove());else if(r.matches(".add-book"))!async function(e){let t=e.closest("td"),r=e.closest("tr"),a=new FormData;r.querySelectorAll("input, textarea").forEach(e=>{("checkbox"!=e.type||e.checked)&&a.append(e.name,e.value)}),r.querySelectorAll("td > img").forEach(e=>a.append("image",e.src)),e.classList.add("hidden"),t.querySelector(".loader-wrapper").classList.remove("hidden");let l=await FormSubmit.fetchRestApi("library/add_book",a);l?(t.innerHTML=l,Main.displayMessage(l.message),r.classList.add("processed")):(e.classList.remove("hidden"),t.querySelector(".loader-wrapper").classList.add("hidden"),e.remove())}(r);else if(r.matches(".delete-book"))r.closest("tr").remove();else if(r.matches(".hide-existing-books"))i("existing-book"),r.remove();else{if(!r.matches(".hide-processed-books"))return;i("processed"),r.remove()}e.stopImmediatePropagation()}),document.addEventListener("change",async e=>{let r=e.target;if("image-selector"==r.name&&r.files.length>0){t=r.closest(".file-upload-wrap"),t.querySelectorAll(".image-preview, .book.table-wrapper").forEach(e=>e.remove());let e=t.querySelector(".book-location");if(!e.reportValidity())return r.value="",void Main.displayMessage("Please select a location for the book.","error");e=e.value,document.querySelectorAll(".book-table-wrapper").forEach(e=>e.remove()),r.closest(".image-selector-wrap").classList.add("hidden"),t.querySelectorAll(".image-preview").forEach(e=>e.remove());for(const a of r.files){let o=new FileReader;o.onload=function(e){let r=document.createElement("div");r.classList.add("image-preview"),r.style.textAlign="center";let a=document.createElement("img");a.src=e.target.result,a.classList.add("book-image"),a.style.maxHeight="100px",a.style.padding="0",r.appendChild(a),t.prepend(r)},o.readAsDataURL(a),l(r,e)}}else{if(!r.matches(".title, .author"))return;{let e=r.closest("tr");e.style.position="relative";let t=Main.showLoader(e.lastChild,!1,e.offsetHeight-100,"Updating book data...");t.style.position="absolute",t.style.top=0,t.style.left=0,t.style.width="100vw",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.color="white",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",await n(e),t.remove()}}e.stopImmediatePropagation()})})();
//# sourceMappingURL=library.min.js.map