(()=>{"use strict";let e,t;async function a(a,s){if(t=a.files.length,t<0)return;let o=new FormData;o.append("action","process_library_upload"),o.append("location",s);for(let e=0;e<t;e++){let t=a.files[e];o.append("files[]",t)}let n=new XMLHttpRequest;n.onreadystatechange=l,n.upload.addEventListener("progress",r,!1),n.open("POST",sim.ajaxUrl,!0),e.querySelectorAll(".loadergif_wrapper").forEach(e=>{e.classList.remove("hidden"),e.querySelectorAll(".uploadmessage").forEach(e=>{e.textContent="Preparing upload",e.classList.add("upload-message")})}),e.querySelector(".uploadmessage").textContent="Uploading Picture(s)",document.getElementById("progress-wrapper").classList.remove("hidden"),n.send(o)}function r(a){if(a.lengthComputable){let r=a.total,l=100*a.loaded/r;l=Math.round(10*l)/10,document.querySelectorAll("#upload_progress").forEach(e=>e.value=l),document.querySelectorAll("#progress_percentage").forEach(e=>e.textContent=`   ${l}%`),l>=99&&(document.getElementById("progress-wrapper").classList.add("hidden"),e.querySelectorAll(".uploadmessage").forEach(e=>{e.textContent=t>1?"Processing images":"Processing image"}))}}function l(t){let a=t.target;4==a.readyState&&(a.status>=200&&a.status<400?function(t){e.innerHTML=JSON.parse(t).data+e.innerHTML,Main.displayMessage("The files have been processed succesfully.","success",!0),e.querySelector(".image-selector-wrap").classList.remove("hidden");const a=new Event("uploadfinished");e.dispatchEvent(a),async function(){e.querySelectorAll("table tr").forEach(async e=>{s(e)})}()}(a.responseText):(console.error(a.responseText),Main.displayMessage(JSON.parse(a.responseText).error,"error")),document.querySelectorAll(".loadergif_wrapper").forEach(function(e){e.classList.add("hidden")}),e.querySelector('input[type="file"]').value="")}async function s(e){try{if(null==e.querySelector(".title"))return;let t=e.querySelector(".title").value,a=e.querySelector(".author").value.split(", ")[0].split(" and ")[0].split("/")[0].split("with")[0].trim(),r="https://openlibrary.org/search.json?q="+encodeURIComponent(`title:${t}`);r+=""!=a?encodeURIComponent(` author:${a}`):"&limit=1",r+="&fields=key,title,subtitle,alternative_subtitle,cover_i,isbn,language,number_of_pages_median,first_publish_year,description";const l=await fetch(r),s=await l.json();let o=s.docs[0]??[];if(""==a){let a=`authorlist-${t.replaceAll(" ","_")}`;e.querySelector(".author").setAttribute("list",a);let r=`<datalist id='${a}' class='author-selection'>`;s.docs.forEach(e=>{null!=e.author_name&&(r+=`<option value='${e.author_name.join()}'>`)}),r+="</datalist>",e.querySelector(".author").insertAdjacentHTML("afterEnd",r)}else a=o.author_name??a,"object"==typeof a&&(a=a.join()??a),e.querySelector(".author").value=o.author_name??a;let n=o.cover_i??"";if(""!=n){let t=`https://covers.openlibrary.org/b/id/${n}-S.jpg`,a=`https://covers.openlibrary.org/b/id/${n}-L.jpg`;e.querySelector(".image").innerHTML=`<input type='hidden' name='image' value='${n}'><a href='${a}' target='_blank'><img src='${t}' class='book-image' loading='lazy'></a>`}let i=t.split(":")[1]??"";""==i&&(i=t.split(",")[1]??""),t=t.split(":")[0].split(",")[0],e.querySelector(".title").value=t;let c=JSON.stringify(o.isbn??""),u=o.first_publish_year??"";u=u[0]??u;let d=o.language??"";d=d[0]??d;let p=o.number_of_pages??o.number_of_pages_median??"",y=`<td><input type='text' name='subtitle' class='subtitle' value='${i}'></td>`;y+=`<td class='hidden'><input type='text' name='isbn' class='isbn' value='${c}'></td>`,y+=`<td><input type='text' name='series' class='series' value='${o.series??""}'></td>`,y+=`<td><input type='text' name='year' class='year' value='${u}'></td>`,y+=`<td><input type='text' name='language' class='language' value='${d}'></td>`,y+=`<td><input type='text' name='pages' class='pages' value='${p}'></td>`;let m=e.querySelector(".placeholder");null==m?(e.querySelector(".subtitle").value=i,e.querySelector(".isbn").value=c,e.querySelector(".series").value=o.series??"",e.querySelector(".year").value=u,e.querySelector(".language").value=d,e.querySelector(".pages").value=p):m.outerHTML=y;let g=e.querySelector(".summary").value;g=null!=o.description&&null!=o.description.value?o.description.value:g;let h=o.key??"";if(""!=h&&(r=`https://openlibrary.org${h}`,e.querySelector(".url").innerHTML=`<a href='${r}' target='_blank'>View on Open Library</a>`,""==g||null==m)){const e=await fetch(r+".json");g=(await e.json()).description??"",g=g.value??g}""!=g&&(e.querySelector(".summary").value=g)}catch(e){console.error("Error fetching book data:",e)}}console.log("library.js loaded"),document.addEventListener("DOMContentLoaded",function(){}),document.addEventListener("click",e=>{let t=e.target;t.matches(".add-book")?async function(e){let t=e.closest("td"),a=e.closest("tr"),r=new FormData;a.querySelectorAll("input, textarea").forEach(e=>r.append(e.name,e.value)),a.querySelectorAll("td > img").forEach(e=>r.append("image",e.src)),e.classList.add("hidden"),t.querySelector(".loadergif_wrapper").classList.remove("hidden");let l=await FormSubmit.fetchRestApi("library/add_book",r);l?(t.innerHTML=l,Main.displayMessage(l.message)):(e.classList.remove("hidden"),t.querySelector(".loadergif_wrapper").classList.add("hidden"))}(t):t.matches(".delete-book")&&t.closest("tr").remove()}),document.addEventListener("change",async t=>{let r=t.target;if("image-selector"==r.name&&r.files.length>0){e=r.closest(".file_upload_wrap");let t=e.querySelector(".book-location");if(!t.reportValidity())return;t=t.value,document.querySelectorAll(".book-table-wrapper").forEach(e=>e.remove()),r.closest(".image-selector-wrap").classList.add("hidden"),e.querySelectorAll(".image-preview").forEach(e=>e.remove());for(const l of r.files){let s=new FileReader;s.onload=function(t){let a=document.createElement("div");a.classList.add("image-preview");let r=document.createElement("img");r.src=t.target.result,r.classList.add("book-image"),r.style.maxHeight="100px",a.appendChild(r),e.prepend(a)},s.readAsDataURL(l),a(r,t)}}else if(r.matches(".title, .author")){let e=r.closest("tr");await s(e),Main.displayMessage("Updated details succesfully.","success",!0)}})})();
//# sourceMappingURL=library.min.js.map