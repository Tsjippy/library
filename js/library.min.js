(()=>{"use strict";function e(e){Array.from(e.options).forEach(function(e){e.defaultSelected=!1})}let t,l=[];function a(e){null!=e.target.closest("td")&&e.target.closest("td").matches(".editing")||(e.stopPropagation(),document.removeEventListener("click",a),o(e,document.querySelector(".editing input, .editing select, .editing textarea")))}function r(e){e.closest("td").classList.add("editing"),t=e.textContent,"Click to update"!=t&&"X"!=t||(t=""),e.innerHTML=`<input type="text" value="${t}">`,function(e){let l=e.querySelectorAll("input,select,textarea");l.forEach(e=>{t.split(",").forEach(l=>{"checkbox"==e.type||"radio"==e.type?e.value==l.trim()&&(e.checked=!0):"select"==e.type?e.querySelector('option[value="'+l+'"]').selected=!0:e.value=t}),"select-one"==e.type&&null==e._niceSelect&&Main.attachNiceSelect(e),e.addEventListener("keyup",function(e){13===e.keyCode&&o(e)}),document.addEventListener("click",a),"checkbox"==e.type&&1!=l.length||("date"==e.type?e.addEventListener("blur",function(e){""!=e.target.value&&o(e)}):e.addEventListener("change",function(e){""!=e.target.value&&o(e)}),e.focus())})}(e)}async function o(e,l){void 0===l&&(l=e.target);let a=l.closest("td"),r=function(e,t,l=!0,a=null,r=!1){let o="",s="",n="",c="";return e instanceof Element?(o=e,"INPUT"!=o.tagName&&"TEXTAREA"!=o.tagName&&"SELECT"!=o.tagName&&null==o.closest(".nice-select-dropdown")&&(o=o.querySelector("input, select, textarea")),null==o&&(o=e),s=o.name):e.match("E[0-9]")?(c=`[id^=${e}]`,o=t.querySelector(c),s=o.name):(s=e,c=`[name='${s}' i]`,o=t.querySelector(c)),null==o?(console.trace(),console.log("cannot find element with name "+s),n):("radio"==o.type?n=function(e,t){let l=e.querySelector(`${t}:checked`);return null==l?"":l.value}(t,c):"checkbox"==o.type?n=function(e,t,l,a){let r="",o="";return"checkbox"==a.type&&null!=l?a.checked?a.value:"":(null!=l?(o=e.querySelector(`${t}[value="${l}" i]:checked`),null!=o&&(r=l)):(o=e.querySelectorAll(`${t}:checked`),r=[],o.forEach(e=>{r.push(e.value)})),r)}(t,c,a,e):null!=o.closest(".nice-select-dropdown")&&null!=o.dataset.value?n=o.dataset.value:null!=o.list&&""!=o.value&&l?n=function(e){let t="",l=e.list.querySelector(`[value='${e.value}' i]`);return t=null==l?e.value:l.dataset.value,t}(o):null!=o.name&&o.name.endsWith("[]")?n=function(e,t){let l=[];return e.querySelectorAll(`[name="${t.name}"]`).forEach(e=>l.push(e.value)),l}(t,o):null!=o.value&&"undefined"!=o.value&&(n=o.value),r?n.toLowerCase():n)}(l,a,!1),o=l.closest("table");if(r!=t){let e=new FormData;e.append("value",JSON.stringify(r));for(let t in a.dataset)e.append(t,a.dataset[t]);for(let t in l.closest("tr").dataset)e.append(t,l.closest("tr").dataset[t]);Main.showLoader(a.firstChild),await FormSubmit.fetchRestApi(o.dataset.url,e)&&(a.innerHTML=r)}else console.log(r),l.closest("td").innerHTML=t;a.classList.remove("editing")}function s(){document.querySelectorAll(".sim-table").forEach(function(e){let t=[];e.querySelectorAll("thead th").forEach((e,l)=>{null!=e.dataset.niceName?t[l]=e.dataset.niceName:t[l]=e.textContent}),e.querySelectorAll("tbody td").forEach(e=>{e.hasAttribute("label")||null==t[e.cellIndex]||e.setAttribute("label",t[e.cellIndex]),"X"!=e.textContent&&""!=e.textContent||e.classList.add("mobile-hidden")})})}async function n(e){e.textContent="Close full screen",e.classList.replace("show","close");let t=e.closest(".table-wrapper");window.lastY=window.pageYOffset,window.scrollTo(0,0),document.querySelector("body").style.overflow="hidden",document.querySelector("header").style.zIndex="unset",t.classList.add("fullscreen"),t.style.marginLeft="0px";let l=new URL(window.location);l.searchParams.set("fullscreen",t.querySelector("table").dataset.formId),window.history.pushState({},"",l),c(),t.requestFullscreen().catch(e=>{})}function c(){let e,t,l=new URLSearchParams(window.location.search).get("fullscreen");document.querySelectorAll(".sim-table").forEach(a=>{let r=a.closest(".table-wrapper");if(null==r)return;null!=l?(t=0,r.querySelectorAll(".table-head").forEach(e=>t=e.offsetHeight)):t=document.querySelector("header").offsetHeight,e=0,r.querySelectorAll(".sim-table-footer").forEach(t=>e=t.offsetHeight);let o=t+e+40;a.style.maxHeight=`calc(100vh - ${o}px)`})}function i(){document.querySelectorAll(".table-wrapper").forEach(e=>{let t="",l=0,a=e.querySelector("table");if(null==a)return;let r=a.scrollWidth;if(0!=r){if(window.innerWidth<570)t=e.getBoundingClientRect().x;else{let a=window.innerWidth-r;r/window.innerWidth<.7?null!=document.querySelector(".is-right-sidebar")&&(a=.7*window.innerWidth-r):(document.getElementById("primary").style.zIndex=1,document.querySelectorAll("#right-sidebar").forEach(e=>e.style.zIndex=0)),l=a<20?10:a/2,""!=e.style.marginLeft&&(e.style.marginLeft="-0px"),t=parseInt(e.getBoundingClientRect().x)-l}e.style.marginLeft=`-${t}px`}})}console.log("Table.js loaded");const d=async e=>{let t;if("SPAN"==e.tagName&&(e=e.querySelector("img")),e.parentNode.matches("th")?t=e.parentNode:e.matches("th")&&(t=e),t){let e=t.closest("table").rows;for(const l of e)l.cells[t.cellIndex].classList.add("hidden");null==sim.hidden&&(sim.hidden=[]),sim.hidden.push(t.cellIndex),t.closest(".table-wrapper").querySelectorAll(".reset-col-vis").forEach(e=>e.classList.remove("hidden"))}};let u,p;async function h(e,t){if(p=e.files.length,p<0)return;let l=new FormData;l.append("action","process_library_upload"),l.append("location",t);for(let t=0;t<p;t++){let a=e.files[t];l.append("files[]",a)}let a=new XMLHttpRequest;a.onreadystatechange=y,a.upload.addEventListener("progress",m,!1),a.open("POST",sim.ajaxUrl,!0),u.querySelectorAll(".loader-wrapper").forEach(e=>{e.classList.remove("hidden"),e.querySelectorAll(".loader-text").forEach(e=>{e.textContent="Preparing upload",e.classList.add("upload-message")})}),u.querySelector(".loader-text").textContent="Uploading Picture(s)",document.getElementById("progress-wrapper").classList.remove("hidden");try{a.send(l)}catch(e){console.error("Error fetching book data:",e),Main.displayMessage(e)}}function m(e){if(e.lengthComputable){let t=e.total,l=100*e.loaded/t;l=Math.round(10*l)/10,document.querySelectorAll("#upload-progress").forEach(e=>e.value=l),document.querySelectorAll("#progress-percentage").forEach(e=>e.textContent=`   ${l}%`),l>=99&&(document.getElementById("progress-wrapper").classList.add("hidden"),u.querySelectorAll(".loader-text").forEach(e=>{e.textContent=p>1?"Processing images":"Processing image"}))}}function y(e){let t=e.target;4==t.readyState&&(t.status>=200&&t.status<400?async function(e){let t=JSON.parse(e);if(!t.success)return Main.displayMessage(`The files failed to process:<br>${t.data[0].message}`,"error"),document.querySelectorAll(".image-selector-wrap.hidden").forEach(e=>e.classList.remove("hidden")),void u.querySelectorAll(".image-preview").forEach(e=>e.remove());let l=document.createElement("div");l.innerHTML=t.data,u.prepend(l),Main.displayMessage("The files have been processed succesfully.","success",!0),u.querySelector(".image-selector-wrap").classList.remove("hidden");const a=new Event("uploadfinished");u.dispatchEvent(a),await async function(){let e=[];u.querySelectorAll("table tr").forEach(async t=>{e.push(f(t))}),await Promise.all(e)}(),s(),null!=sim.hidden&&sim.hidden.forEach(e=>d(l.querySelectorAll(".sim-table th")[e]))}(t.responseText):(console.error(t.responseText),Main.displayMessage(JSON.parse(t.responseText).error,"error")),document.querySelectorAll(".loader-wrapper").forEach(function(e){e.classList.add("hidden")}),u.querySelector('input[type="file"]').value="")}async function f(t){try{if(null==t.querySelector(".title"))return;let a=t.querySelector(".title").value,r=t.querySelector(".author").value.trim(),o="https://openlibrary.org/search.json?q="+encodeURIComponent(`title:${a}`);""!=r&&(o+=encodeURIComponent(` author:${r}`)+"&limit=1"),o+="&fields=key,title,author_name,subtitle,alternative_subtitle,cover_i,language,number_of_pages_median,first_publish_year,description,subjects";const s=await fetch(o),n=await s.json();let c=n.docs[0]??[];if(0==c.length&&""==r){let e=`authorlist-${a.replaceAll(" ","_").replaceAll("'","")}`;t.querySelectorAll(".author").forEach(t=>t.setAttribute("list",e));let l=`<datalist id='${e}' class='author-selection'>`;n.docs.forEach(e=>{null!=e.author_name&&(l+=`<option value='${e.author_name.join()}'>`)}),l+="</datalist>",t.querySelector(".authors").insertAdjacentHTML("afterEnd",l)}else{let a=c.author_name??[r],o=t.querySelector(".authors.clone-divs-wrapper"),s=o.querySelector(".clone-div");a.forEach(t=>{let a=function(t,a=!0){!function(e){"undefined"!=typeof tinymce&&e.querySelectorAll(".wp-editor-area").forEach(e=>{let t=tinymce.get(e.id);null!=t&&(l[e.id]=t.settings,t.save(),t.remove())})}(t);let r=t.cloneNode(!0);return r.querySelectorAll(".nice-select").forEach(e=>e.remove()),t.querySelectorAll(".wp-editor-area").forEach(e=>{null!=l[e.id]&&tinymce.init(l[e.id])}),a&&r.querySelectorAll("input,select,textarea").forEach(t=>{"checkbox"==t.type||"radio"==t.type?t.checked=!1:t.matches(".no-reset")||(t.value=""),"select-one"==t.type&&e(t)}),r.querySelectorAll("select").forEach(t=>{e(t),Main.attachNiceSelect(t)}),r}(s);a.querySelector(".author").value=t,o.appendChild(a)}),s.remove()}let i=c.cover_i??"";if(""!=i){let e=`https://covers.openlibrary.org/b/id/${i}-S.jpg`,l=`https://covers.openlibrary.org/b/id/${i}-L.jpg`;t.querySelector(".image").innerHTML=`<input type='hidden' class='no-reset' name='image' value='${i}'><a href='${l}' target='_blank'><img src='${e}' class='book-image' loading='lazy'></a>`}let d=c.subtitle??"",u=c.first_publish_year??"";u=u[0]??u;let p=c.language??"";p=p[0]??p;let h=c.number_of_pages??c.number_of_pages_median??"",m=`<td><input type='text' name='subtitle' class='subtitle' value='${d}'></td>`;m+=`<td><input type='text' name='series' class='series' value='${c.series??""}'></td>`,m+=`<td><input type='text' name='year' class='year' value='${u}'></td>`,m+=`<td><input type='text' name='language' class='language' value='${p}'></td>`,m+=`<td><input type='text' name='pages' class='pages' value='${h}'></td>`;let y=t.querySelector(".placeholder");null==y?(t.querySelector(".subtitle").value=d,t.querySelector(".series").value=c.series??"",t.querySelector(".year").value=u,t.querySelector(".language").value=p,t.querySelector(".pages").value=h):y.outerHTML=m;let f=t.querySelector(".description").value;f=null!=c.description&&null!=c.description.value?c.description.value:"";let g=c.key??"",v="";if(""!=g){o=`https://openlibrary.org${g}`,t.querySelector(".url").innerHTML=`\n\t\t\t<input type='hidden' class='no-reset' name='url' value='${o}'>\n\t\t\t<a href='${o}' target='_blank'>View on Open Library</a>\n\t\t\t`;const e=await fetch(o+".json");v=await e.json(),f=v.description??"",f=f.value??f,null!=v.subjects&&v.subjects.forEach(e=>{t.querySelectorAll(`.category-select [data-name="${e}"]`).forEach(e=>e.checked=!0)})}""!=f&&(t.querySelector(".description").value=f),""!=i&&""!=g&&void 0!==v&&null!=v.subjects&&t.querySelector(".add-book").click()}catch(e){console.error("Error fetching book data:",e)}}function g(e){let t=document.createElement("style");t.innerHTML=`.${e} { display: none; }`,document.getElementsByTagName("head")[0].appendChild(t),new URL(window.location).searchParams.set("hide",e)}document.addEventListener("click",e=>{let t=e.target;"TH"==t.tagName&&function(e){let t,l,a,r=e.closest("table"),o=!0;var s="asc";for(e.classList.contains("desc")&&(s="desc");o;){o=!1,a=r.rows;for(let r=1;r<a.length-1;r++){if(t=a[r].getElementsByTagName("TD")[e.cellIndex].innerHTML.toLowerCase(),l=a[r+1].getElementsByTagName("TD")[e.cellIndex].innerHTML.toLowerCase(),isNaN(t)||isNaN(l)){let e=new Date(t),a=new Date(l);"Invalid Date"===e||isNaN(e)||70==e.getYear()||"Invalid Date"===a||isNaN(a)||70==a.getYear()||(t=e.getTime(),l=a.getTime())}else t=parseFloat(t),l=parseFloat(l);("asc"==s&&t>l||"desc"==s&&l>t)&&(a[r].parentNode.insertBefore(a[r+1],a[r]),o=!0)}}"asc"==s?(e.classList.add("desc"),e.classList.replace("asc","desc")):e.classList.replace("desc","asc")}(t);let l=t.closest("td");t.matches("td.edit")?(e.stopPropagation(),r(t)):null!=l&&l.matches("td.edit")&&"INPUT"!=t.tagName&&"A"!=t.tagName&&"TEXTAREA"!=t.tagName&&!t.closest(".nice-select")?(e.stopPropagation(),r(t.closest("td"))):t.matches(".show.fullscreenbutton")?n(t):t.matches(".close.fullscreenbutton")?function(e){let t=100;e.textContent="Show full screen",e.classList.replace("close","show"),null!=window.lastY&&(t=window.lastY),window.scrollTo(0,t),console.log("scrolling"),document.querySelector("body").style.overflow="unset",document.querySelector("header").style.zIndex="99999",e.closest(".table-wrapper").classList.remove("fullscreen"),i();let l=new URL(window.location);l.searchParams.delete("fullscreen"),window.history.pushState({},"",l),document.exitFullscreen(),c()}(t):t.classList.contains("visibility-icon")?d(t):t.matches(".reset-col-vis")&&async function(e){e.closest(".table-wrapper").querySelector(".reset-col-vis").classList.add("hidden"),e.closest(".form.table-wrapper").querySelector("table").querySelectorAll("th.hidden, td.hidden").forEach(e=>e.classList.remove("hidden"))}(t)}),document.addEventListener("DOMContentLoaded",function(){i(),window.addEventListener("resize",i),s();let e=new URLSearchParams(window.location.search).get("fullscreen");if(null!=e)try{n(document.querySelector(`table[data-form-id="${e}"]`).closest(".table-wrapper").querySelector(".fullscreenbutton"))}catch{console.error(`table[data-form-id="${e}"]`)}c()}),console.log("library.js loaded"),document.addEventListener("DOMContentLoaded",function(){}),document.addEventListener("click",e=>{let t=e.target;null!=u&&t.matches(".add-books")?u.querySelectorAll(".image-preview, .book.table-wrapper").forEach(e=>e.remove()):t.matches(".add-book")?async function(e){let t=e.closest("td"),l=e.closest("tr"),a=new FormData;l.querySelectorAll("input, textarea").forEach(e=>{("checkbox"!=e.type||e.checked)&&a.append(e.name,e.value)}),l.querySelectorAll("td > img").forEach(e=>a.append("image",e.src)),e.classList.add("hidden"),t.querySelector(".loader-wrapper").classList.remove("hidden");let r=await FormSubmit.fetchRestApi("library/add_book",a);r?(t.innerHTML=r,Main.displayMessage(r.message),l.classList.add("processed")):(e.classList.remove("hidden"),t.querySelector(".loader-wrapper").classList.add("hidden"),e.remove())}(t):t.matches(".delete-book")?t.closest("tr").remove():t.matches(".hide-existing-books")?(g("existing-book"),t.remove()):t.matches(".hide-processed-books")&&(g("processed"),t.remove())}),document.addEventListener("change",async e=>{let t=e.target;if("image-selector"==t.name&&t.files.length>0){u=t.closest(".file-upload-wrap"),u.querySelectorAll(".image-preview, .book.table-wrapper").forEach(e=>e.remove());let e=u.querySelector(".book-location");if(!e.reportValidity())return t.value="",void Main.displayMessage("Please select a location for the book.","error");e=e.value,document.querySelectorAll(".book-table-wrapper").forEach(e=>e.remove()),t.closest(".image-selector-wrap").classList.add("hidden"),u.querySelectorAll(".image-preview").forEach(e=>e.remove());for(const l of t.files){let a=new FileReader;a.onload=function(e){let t=document.createElement("div");t.classList.add("image-preview"),t.style.textAlign="center";let l=document.createElement("img");l.src=e.target.result,l.classList.add("book-image"),l.style.maxHeight="100px",l.style.padding="0",t.appendChild(l),u.prepend(t)},a.readAsDataURL(l),h(t,e)}}else if(t.matches(".title, .author")){let e=t.closest("tr");e.style.position="relative";let l=Main.showLoader(e.lastChild,!1,e.offsetHeight-100,"Updating book data...");l.style.position="absolute",l.style.top=0,l.style.left=0,l.style.width="100vw",l.style.height="100%",l.style.backgroundColor="rgba(0, 0, 0, 0.5)",l.style.color="white",l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",await f(e),l.remove()}})})();
//# sourceMappingURL=library.min.js.map